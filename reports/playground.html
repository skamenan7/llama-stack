<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Stack API Playground</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-code: #1e2430;
            --border: #30363d;
            --primary: #e53935;
            --accent: #ff6f00;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --text-yellow: #ffd54f;
            --text-orange: #ffab40;
            --text-purple: #ce93d8;
            --sidebar-width: 180px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: var(--bg-dark);
            color: var(--text-yellow);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 120px;
            max-width: 400px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }

        .sidebar h1 {
            color: var(--primary);
            font-size: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        /* Resize Handle */
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
        }
        .resize-handle:hover, .resize-handle.dragging {
            background: var(--primary);
        }

        .api-group { border-bottom: 1px solid var(--border); }

        .api-group-header {
            padding: 0.5rem 0.75rem;
            color: var(--accent);
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .api-group-header:hover { background: rgba(255, 111, 0, 0.1); }

        .api-group-items { display: none; }
        .api-group.open .api-group-items { display: block; }

        .api-item {
            padding: 0.4rem 0.5rem 0.4rem 0.75rem;
            color: var(--text-yellow);
            font-size: 0.8rem;
            cursor: pointer;
            border-left: 3px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .api-item:hover {
            background: rgba(255, 213, 79, 0.1);
            border-left-color: var(--text-yellow);
        }
        .api-item.active {
            background: rgba(229, 57, 53, 0.2);
            border-left-color: var(--primary);
            color: var(--primary);
        }

        .method-tag {
            font-size: 0.6rem;
            padding: 0.1rem 0.25rem;
            border-radius: 2px;
            margin-right: 0.3rem;
            font-weight: bold;
        }
        .method-tag.get { background: var(--success); color: #000; }
        .method-tag.post { background: var(--warning); color: #000; }
        .method-tag.delete { background: var(--error); color: #fff; }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.4rem 0.75rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .id-selector {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .id-selector label {
            color: var(--accent);
            font-size: 0.75rem;
            font-weight: bold;
        }
        .id-selector button {
            padding: 0.2rem 0.4rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .id-selector select {
            width: 140px;
            padding: 0.25rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-yellow);
            font-size: 0.75rem;
        }

        /* Request Area */
        .request-area {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .url-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .method-select {
            padding: 0.4rem 0.5rem;
            background: var(--warning);
            color: #000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .method-select.get { background: var(--success); }
        .method-select.post { background: var(--warning); }
        .method-select.delete { background: var(--error); color: #fff; }

        .url-input {
            width: 400px;
            padding: 0.4rem 0.5rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-orange);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .send-btn {
            padding: 0.4rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .send-btn:hover { background: #c62828; }

        .request-body {
            width: 100%;
            min-height: 120px;
            padding: 0.5rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-yellow);
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
        }

        /* Response Area */
        .response-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0.75rem;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .response-tabs {
            display: flex;
            gap: 0.5rem;
        }
        .response-tab {
            padding: 0.3rem 0.6rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-yellow);
            cursor: pointer;
            font-size: 0.8rem;
        }
        .response-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .response-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }
        .response-meta .status { font-weight: bold; }
        .response-meta .status.ok { color: var(--success); }
        .response-meta .status.error { color: var(--error); }

        .response-output {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: auto;
            font-family: monospace;
            font-size: 0.8rem;
        }

        /* JSON Tree */
        .json-tree { color: var(--text-yellow); }
        .json-key { color: var(--text-purple); }
        .json-string { color: var(--success); }
        .json-number { color: var(--text-orange); }
        .json-boolean { color: var(--warning); }
        .json-null { color: var(--error); }

        .json-toggle {
            cursor: pointer;
            user-select: none;
            color: var(--accent);
            margin-right: 0.3rem;
        }
        .json-toggle:hover { color: var(--primary); }

        .json-collapsed { display: none; }
        .json-bracket { color: var(--text-yellow); }
        .json-item { margin-left: 1.2rem; }
        .json-preview { color: #666; font-style: italic; }

        /* Search */
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .search-input {
            width: 180px;
            padding: 0.25rem 0.5rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-yellow);
            font-size: 0.8rem;
        }
        .search-input:focus { border-color: var(--accent); outline: none; }
        .search-nav {
            padding: 0.2rem 0.4rem;
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-yellow);
            cursor: pointer;
            font-size: 0.75rem;
        }
        .search-nav:hover { border-color: var(--accent); }
        .search-count { font-size: 0.75rem; color: var(--accent); min-width: 50px; }
        .search-highlight { background: var(--warning); color: #000; padding: 0 1px; border-radius: 2px; }
        .search-highlight.current { background: var(--primary); color: #fff; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            width: 380px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .modal-header h3 { color: var(--success); }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-yellow);
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <h1>API Playground</h1>
        <div class="resize-handle" id="resize-handle"></div>

        <div class="api-group open">
            <div class="api-group-header" onclick="toggleGroup(this)">Core <span>-</span></div>
            <div class="api-group-items">
                <div class="api-item" onclick="loadEndpoint('health')"><span class="method-tag get">GET</span>Health</div>
                <div class="api-item" onclick="loadEndpoint('models')"><span class="method-tag get">GET</span>Models</div>
                <div class="api-item" onclick="loadEndpoint('providers')"><span class="method-tag get">GET</span>Providers</div>
                <div class="api-item" onclick="loadEndpoint('routes')"><span class="method-tag get">GET</span>Routes</div>
            </div>
        </div>

        <div class="api-group open">
            <div class="api-group-header" onclick="toggleGroup(this)">Inference <span>-</span></div>
            <div class="api-group-items">
                <div class="api-item" onclick="loadEndpoint('chat')"><span class="method-tag post">POST</span>Chat</div>
                <div class="api-item" onclick="loadEndpoint('chat-stream')"><span class="method-tag post">POST</span>Stream</div>
            </div>
        </div>

        <div class="api-group open">
            <div class="api-group-header" onclick="toggleGroup(this)">VectorIO <span>-</span></div>
            <div class="api-group-items">
                <div class="api-item" onclick="loadEndpoint('vector-list')"><span class="method-tag get">GET</span>List</div>
                <div class="api-item" onclick="loadEndpoint('vector-create')"><span class="method-tag post">POST</span>Create</div>
                <div class="api-item" onclick="loadEndpoint('vector-get')"><span class="method-tag get">GET</span>Get</div>
                <div class="api-item" onclick="loadEndpoint('vector-delete')"><span class="method-tag delete">DEL</span>Delete</div>
                <div class="api-item" onclick="loadEndpoint('vector-search')"><span class="method-tag post">POST</span>Search</div>
                <div class="api-item" onclick="loadEndpoint('vector-attach')"><span class="method-tag post">POST</span>Attach</div>
            </div>
        </div>

        <div class="api-group open">
            <div class="api-group-header" onclick="toggleGroup(this)">Files <span>-</span></div>
            <div class="api-group-items">
                <div class="api-item" onclick="openUploadModal()"><span class="method-tag post">POST</span>Upload</div>
                <div class="api-item" onclick="loadEndpoint('files-list')"><span class="method-tag get">GET</span>List</div>
                <div class="api-item" onclick="loadEndpoint('files-get')"><span class="method-tag get">GET</span>Get</div>
                <div class="api-item" onclick="loadEndpoint('files-delete')"><span class="method-tag delete">DEL</span>Delete</div>
            </div>
        </div>

        <div class="api-group">
            <div class="api-group-header" onclick="toggleGroup(this)">Responses <span>+</span></div>
            <div class="api-group-items">
                <div class="api-item" onclick="loadEndpoint('response-create')"><span class="method-tag post">POST</span>Create</div>
                <div class="api-item" onclick="loadEndpoint('response-list')"><span class="method-tag get">GET</span>List</div>
                <div class="api-item" onclick="loadEndpoint('response-get')"><span class="method-tag get">GET</span>Get</div>
                <div class="api-item" onclick="loadEndpoint('response-delete')"><span class="method-tag delete">DEL</span>Delete</div>
            </div>
        </div>

        <div class="api-group">
            <div class="api-group-header" onclick="toggleGroup(this)">Tools <span>+</span></div>
            <div class="api-group-items">
                <div class="api-item" onclick="loadEndpoint('tools-list')"><span class="method-tag get">GET</span>List</div>
                <div class="api-item" onclick="loadEndpoint('toolgroups-list')"><span class="method-tag get">GET</span>Groups</div>
                <div class="api-item" onclick="loadEndpoint('tool-invoke')"><span class="method-tag post">POST</span>Invoke</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="top-bar">
            <div class="id-selector">
                <button onclick="fetchList('model')">Load</button>
                <label>Model:</label>
                <select id="model-dropdown" onchange="insertFromDropdown('model')"><option value="">--</option></select>
            </div>
            <div class="id-selector">
                <button onclick="fetchList('store')">Load</button>
                <label>Store:</label>
                <select id="store-dropdown" onchange="insertFromDropdown('store')"><option value="">--</option></select>
            </div>
            <div class="id-selector">
                <button onclick="fetchList('file')">Load</button>
                <label>File:</label>
                <select id="file-dropdown" onchange="insertFromDropdown('file')"><option value="">--</option></select>
            </div>
            <div class="id-selector">
                <button onclick="fetchList('response')">Load</button>
                <label>Resp:</label>
                <select id="response-dropdown" onchange="insertFromDropdown('response')"><option value="">--</option></select>
            </div>
        </div>

        <div class="request-area">
            <div class="url-bar">
                <select id="method-select" class="method-select post" onchange="updateMethodStyle()">
                    <option value="GET">GET</option>
                    <option value="POST" selected>POST</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <input type="text" id="url-input" class="url-input" value="/api/v1/chat/completions">
                <button class="send-btn" onclick="sendRequest()">Send</button>
            </div>
            <textarea id="request-body" class="request-body">{
  "model": "openai/gpt-4o-mini",
  "messages": [{"role": "user", "content": "Hello!"}]
}</textarea>
        </div>

        <div class="response-area">
            <div class="response-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="response-tabs">
                        <button class="response-tab active" onclick="setViewMode('tree')">Tree</button>
                        <button class="response-tab" onclick="setViewMode('raw')">Raw</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="search-input" class="search-input" placeholder="Search..." oninput="searchJson()" onkeydown="handleSearchKey(event)">
                        <button class="search-nav" onclick="prevMatch()">▲</button>
                        <button class="search-nav" onclick="nextMatch()">▼</button>
                        <span id="search-count" class="search-count"></span>
                    </div>
                </div>
                <div class="response-meta" id="response-meta" style="display: none;">
                    <span>Status: <span id="resp-status" class="status">-</span></span>
                    <span>Time: <span id="resp-time">-</span></span>
                    <span>Size: <span id="resp-size">-</span></span>
                </div>
            </div>
            <div id="response-output" class="response-output">Click an endpoint, then Send.</div>
        </div>
    </main>

    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload File</h3>
                <button class="modal-close" onclick="closeUploadModal()">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label style="width: 55px;">Purpose:</label>
                    <select id="file-purpose" style="flex: 1; padding: 0.4rem; background: var(--bg-code); border: 1px solid var(--border); border-radius: 4px; color: var(--text-yellow);">
                        <option value="assistants">assistants</option>
                        <option value="batch">batch</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label style="width: 55px;">File:</label>
                    <input type="file" id="file-input" style="flex: 1; color: var(--text-yellow); font-size: 0.85rem;">
                </div>
                <div id="upload-status" style="display: none; font-size: 0.85rem;"></div>
                <button onclick="uploadFile()" class="send-btn" style="align-self: flex-end;">Upload</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = '/api';
        let viewMode = 'tree';
        let lastJsonResponse = null;

        const endpoints = {
            'health': { method: 'GET', url: `${BASE_URL}/v1/health`, body: '' },
            'models': { method: 'GET', url: `${BASE_URL}/v1/models`, body: '' },
            'providers': { method: 'GET', url: `${BASE_URL}/v1/providers`, body: '' },
            'routes': { method: 'GET', url: `${BASE_URL}/v1/inspect/routes`, body: '' },
            'chat': { method: 'POST', url: `${BASE_URL}/v1/chat/completions`, body: JSON.stringify({ model: 'openai/gpt-4o-mini', messages: [{ role: 'user', content: 'Hello!' }], stream: false }, null, 2) },
            'chat-stream': { method: 'POST', url: `${BASE_URL}/v1/chat/completions`, body: JSON.stringify({ model: 'openai/gpt-4o-mini', messages: [{ role: 'user', content: 'Count to 5' }], stream: true }, null, 2) },
            'vector-list': { method: 'GET', url: `${BASE_URL}/v1/vector_stores`, body: '' },
            'vector-create': { method: 'POST', url: `${BASE_URL}/v1/vector_stores`, body: JSON.stringify({ name: 'my-store', chunking_strategy: { type: 'auto' } }, null, 2) },
            'vector-get': { method: 'GET', url: `${BASE_URL}/v1/vector_stores/{vector_store_id}`, body: '' },
            'vector-delete': { method: 'DELETE', url: `${BASE_URL}/v1/vector_stores/{vector_store_id}`, body: '' },
            'vector-search': { method: 'POST', url: `${BASE_URL}/v1/vector_stores/{vector_store_id}/search`, body: JSON.stringify({ query: 'search query', max_num_results: 10 }, null, 2) },
            'vector-attach': { method: 'POST', url: `${BASE_URL}/v1/vector_stores/{vector_store_id}/files`, body: JSON.stringify({ file_id: '{file_id}' }, null, 2) },
            'files-list': { method: 'GET', url: `${BASE_URL}/v1/files`, body: '' },
            'files-get': { method: 'GET', url: `${BASE_URL}/v1/files/{file_id}`, body: '' },
            'files-delete': { method: 'DELETE', url: `${BASE_URL}/v1/files/{file_id}`, body: '' },
            'response-create': { method: 'POST', url: `${BASE_URL}/v1/responses`, body: JSON.stringify({ model: 'openai/gpt-4o-mini', input: 'What is 2+2?' }, null, 2) },
            'response-list': { method: 'GET', url: `${BASE_URL}/v1/responses`, body: '' },
            'response-get': { method: 'GET', url: `${BASE_URL}/v1/responses/{response_id}`, body: '' },
            'response-delete': { method: 'DELETE', url: `${BASE_URL}/v1/responses/{response_id}`, body: '' },
            'tools-list': { method: 'GET', url: `${BASE_URL}/v1/tools`, body: '' },
            'toolgroups-list': { method: 'GET', url: `${BASE_URL}/v1/toolgroups`, body: '' },
            'tool-invoke': { method: 'POST', url: `${BASE_URL}/v1/tool-runtime/invoke`, body: JSON.stringify({ tool_name: 'web_search', kwargs: { query: 'llama stack' } }, null, 2) }
        };

        // Sidebar resize
        const sidebar = document.getElementById('sidebar');
        const handle = document.getElementById('resize-handle');
        let isResizing = false;

        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            handle.classList.add('dragging');
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            if (!isResizing) return;
            const width = e.clientX;
            if (width >= 120 && width <= 400) {
                sidebar.style.width = width + 'px';
            }
        }

        function stopResize() {
            isResizing = false;
            handle.classList.remove('dragging');
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

        function toggleGroup(header) {
            const group = header.parentElement;
            group.classList.toggle('open');
            header.querySelector('span').textContent = group.classList.contains('open') ? '-' : '+';
        }

        function loadEndpoint(name) {
            const ep = endpoints[name];
            if (!ep) return;
            document.getElementById('method-select').value = ep.method;
            document.getElementById('url-input').value = ep.url;
            document.getElementById('request-body').value = ep.body;
            updateMethodStyle();
            document.querySelectorAll('.api-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.api-item')?.classList.add('active');
        }

        function updateMethodStyle() {
            const select = document.getElementById('method-select');
            select.className = 'method-select ' + select.value.toLowerCase();
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.querySelectorAll('.response-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (lastJsonResponse) renderResponse(lastJsonResponse);
        }

        // JSON Tree Renderer
        function renderJsonTree(data, collapsed = false) {
            if (data === null) return '<span class="json-null">null</span>';
            if (typeof data === 'boolean') return `<span class="json-boolean">${data}</span>`;
            if (typeof data === 'number') return `<span class="json-number">${data}</span>`;
            if (typeof data === 'string') return `<span class="json-string">"${escapeHtml(data)}"</span>`;

            if (Array.isArray(data)) {
                if (data.length === 0) return '<span class="json-bracket">[]</span>';
                const id = 'j' + Math.random().toString(36).substr(2, 9);
                const preview = data.length + ' items';
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span><span class="json-bracket">[</span><span class="json-preview" id="${id}-preview" style="display:none"> ${preview} </span>`;
                html += `<div class="json-item" id="${id}">`;
                data.forEach((item, i) => {
                    html += renderJsonTree(item) + (i < data.length - 1 ? ',' : '') + '<br>';
                });
                html += '</div><span class="json-bracket">]</span>';
                return html;
            }

            if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) return '<span class="json-bracket">{}</span>';
                const id = 'j' + Math.random().toString(36).substr(2, 9);
                const preview = keys.length + ' keys';
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span><span class="json-bracket">{</span><span class="json-preview" id="${id}-preview" style="display:none"> ${preview} </span>`;
                html += `<div class="json-item" id="${id}">`;
                keys.forEach((key, i) => {
                    html += `<span class="json-key">"${escapeHtml(key)}"</span>: ${renderJsonTree(data[key])}${i < keys.length - 1 ? ',' : ''}<br>`;
                });
                html += '</div><span class="json-bracket">}</span>';
                return html;
            }
            return String(data);
        }

        function toggleJson(id) {
            const el = document.getElementById(id);
            const preview = document.getElementById(id + '-preview');
            const toggle = el.previousElementSibling.previousElementSibling;
            if (el.classList.contains('json-collapsed')) {
                el.classList.remove('json-collapsed');
                preview.style.display = 'none';
                toggle.textContent = '▼';
            } else {
                el.classList.add('json-collapsed');
                preview.style.display = 'inline';
                toggle.textContent = '▶';
            }
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function renderResponse(json) {
            const output = document.getElementById('response-output');
            if (viewMode === 'tree') {
                output.innerHTML = '<div class="json-tree">' + renderJsonTree(json) + '</div>';
            } else {
                output.textContent = JSON.stringify(json, null, 2);
            }
        }

        async function sendRequest() {
            const method = document.getElementById('method-select').value;
            const url = document.getElementById('url-input').value;
            const body = document.getElementById('request-body').value;
            const output = document.getElementById('response-output');
            const meta = document.getElementById('response-meta');

            output.textContent = 'Loading...';
            lastJsonResponse = null;
            document.getElementById('search-input').value = '';
            document.getElementById('search-count').textContent = '';
            searchMatches = [];
            currentMatchIndex = -1;
            const startTime = performance.now();

            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (method !== 'GET' && body.trim()) options.body = body;

                const response = await fetch(url, options);
                const endTime = performance.now();

                document.getElementById('resp-status').textContent = response.status;
                document.getElementById('resp-status').className = 'status ' + (response.ok ? 'ok' : 'error');
                document.getElementById('resp-time').textContent = Math.round(endTime - startTime) + 'ms';

                const text = await response.text();
                document.getElementById('resp-size').textContent = (text.length / 1024).toFixed(1) + 'KB';
                meta.style.display = 'flex';

                try {
                    const json = JSON.parse(text);
                    lastJsonResponse = json;
                    renderResponse(json);
                    extractIdsFromResponse(url, json);
                } catch {
                    output.textContent = text;
                }
            } catch (e) {
                output.textContent = 'Error: ' + e.message;
                meta.style.display = 'none';
            }
        }

        // Dropdowns
        function populateDropdown(type, ids) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            dropdown.innerHTML = '<option value="">--</option>';
            ids.slice(0, 50).forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = id.length > 20 ? id.substring(0, 20) + '...' : id;
                dropdown.appendChild(opt);
            });
            dropdown.style.borderColor = 'var(--success)';
            setTimeout(() => dropdown.style.borderColor = 'var(--border)', 800);
        }

        function insertFromDropdown(type) {
            const value = document.getElementById(`${type}-dropdown`).value;
            if (!value) return;
            const urlInput = document.getElementById('url-input');
            const bodyInput = document.getElementById('request-body');
            if (type === 'model') bodyInput.value = bodyInput.value.replace(/"model":\s*"[^"]*"/, `"model": "${value}"`);
            if (type === 'store') urlInput.value = urlInput.value.replace(/{vector_store_id}/g, value);
            if (type === 'file') { urlInput.value = urlInput.value.replace(/{file_id}/g, value); bodyInput.value = bodyInput.value.replace(/"{file_id}"/g, `"${value}"`); }
            if (type === 'response') urlInput.value = urlInput.value.replace(/{response_id}/g, value);
        }

        async function fetchList(type) {
            const urls = { model: '/api/v1/models', store: '/api/v1/vector_stores', file: '/api/v1/files', response: '/api/v1/responses' };
            const dropdown = document.getElementById(`${type}-dropdown`);
            dropdown.innerHTML = '<option>...</option>';
            try {
                const res = await fetch(urls[type]);
                const data = await res.json();
                if (data?.data) populateDropdown(type, data.data.map(i => i.id).filter(Boolean));
            } catch { dropdown.innerHTML = '<option>Error</option>'; }
        }

        function extractIdsFromResponse(url, data) {
            if (url.includes('/models') && data?.data) populateDropdown('model', data.data.map(m => m.id).filter(Boolean));
            if (url.includes('/vector_stores') && !url.includes('{') && data?.data) populateDropdown('store', data.data.map(s => s.id).filter(Boolean));
            if (url.includes('/files') && !url.includes('{') && data?.data) populateDropdown('file', data.data.map(f => f.id).filter(Boolean));
            if (url.includes('/responses') && !url.includes('{') && data?.data) populateDropdown('response', data.data.map(r => r.id).filter(Boolean));
        }

        function openUploadModal() { document.getElementById('upload-modal').classList.add('open'); }
        function closeUploadModal() { document.getElementById('upload-modal').classList.remove('open'); }

        async function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const purpose = document.getElementById('file-purpose').value;
            const status = document.getElementById('upload-status');
            if (!fileInput.files[0]) { status.textContent = 'Select a file'; status.style.display = 'block'; status.style.color = 'var(--error)'; return; }
            const formData = new FormData();
            formData.append('purpose', purpose);
            formData.append('file', fileInput.files[0]);
            status.textContent = 'Uploading...'; status.style.display = 'block'; status.style.color = 'var(--warning)';
            try {
                const res = await fetch('/api/v1/files', { method: 'POST', body: formData });
                const data = await res.json();
                if (res.ok) { status.textContent = 'Done: ' + data.id; status.style.color = 'var(--success)'; fetchList('file'); }
                else { status.textContent = 'Error: ' + (data.error || res.statusText); status.style.color = 'var(--error)'; }
            } catch (e) { status.textContent = 'Error: ' + e.message; status.style.color = 'var(--error)'; }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeUploadModal();
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('search-input').focus();
            }
        });

        // Search functionality
        let searchMatches = [];
        let currentMatchIndex = -1;

        function searchJson() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            const countEl = document.getElementById('search-count');
            searchMatches = [];
            currentMatchIndex = -1;

            if (!lastJsonResponse || !query) {
                countEl.textContent = '';
                renderResponse(lastJsonResponse);
                return;
            }

            // Re-render with highlights
            if (viewMode === 'tree') {
                const output = document.getElementById('response-output');
                output.innerHTML = '<div class="json-tree">' + renderJsonTreeWithSearch(lastJsonResponse, query) + '</div>';
            } else {
                const output = document.getElementById('response-output');
                const raw = JSON.stringify(lastJsonResponse, null, 2);
                output.innerHTML = highlightMatches(escapeHtml(raw), query);
            }

            // Collect all matches
            searchMatches = Array.from(document.querySelectorAll('.search-highlight'));
            countEl.textContent = searchMatches.length > 0 ? `${searchMatches.length} found` : 'No matches';

            if (searchMatches.length > 0) {
                currentMatchIndex = 0;
                highlightCurrentMatch();
            }
        }

        function renderJsonTreeWithSearch(data, query) {
            if (data === null) return '<span class="json-null">null</span>';
            if (typeof data === 'boolean') return `<span class="json-boolean">${data}</span>`;
            if (typeof data === 'number') {
                const numStr = String(data);
                return `<span class="json-number">${highlightMatches(numStr, query)}</span>`;
            }
            if (typeof data === 'string') {
                const escaped = escapeHtml(data);
                return `<span class="json-string">"${highlightMatches(escaped, query)}"</span>`;
            }

            if (Array.isArray(data)) {
                if (data.length === 0) return '<span class="json-bracket">[]</span>';
                const id = 'j' + Math.random().toString(36).substr(2, 9);
                const preview = data.length + ' items';
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span><span class="json-bracket">[</span><span class="json-preview" id="${id}-preview" style="display:none"> ${preview} </span>`;
                html += `<div class="json-item" id="${id}">`;
                data.forEach((item, i) => {
                    html += renderJsonTreeWithSearch(item, query) + (i < data.length - 1 ? ',' : '') + '<br>';
                });
                html += '</div><span class="json-bracket">]</span>';
                return html;
            }

            if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) return '<span class="json-bracket">{}</span>';
                const id = 'j' + Math.random().toString(36).substr(2, 9);
                const preview = keys.length + ' keys';
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span><span class="json-bracket">{</span><span class="json-preview" id="${id}-preview" style="display:none"> ${preview} </span>`;
                html += `<div class="json-item" id="${id}">`;
                keys.forEach((key, i) => {
                    const keyHtml = highlightMatches(escapeHtml(key), query);
                    html += `<span class="json-key">"${keyHtml}"</span>: ${renderJsonTreeWithSearch(data[key], query)}${i < keys.length - 1 ? ',' : ''}<br>`;
                });
                html += '</div><span class="json-bracket">}</span>';
                return html;
            }
            return String(data);
        }

        function highlightMatches(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightCurrentMatch() {
            searchMatches.forEach((el, i) => {
                el.classList.toggle('current', i === currentMatchIndex);
            });
            if (searchMatches[currentMatchIndex]) {
                searchMatches[currentMatchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            document.getElementById('search-count').textContent = `${currentMatchIndex + 1}/${searchMatches.length}`;
        }

        function nextMatch() {
            if (searchMatches.length === 0) return;
            currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
            highlightCurrentMatch();
        }

        function prevMatch() {
            if (searchMatches.length === 0) return;
            currentMatchIndex = (currentMatchIndex - 1 + searchMatches.length) % searchMatches.length;
            highlightCurrentMatch();
        }

        function handleSearchKey(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) prevMatch();
                else nextMatch();
                e.preventDefault();
            }
        }
    </script>
</body>
</html>
